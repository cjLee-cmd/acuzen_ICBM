# 약물감시 시스템 기술 구현 가이드

## 1. 개발 환경 설정

### 필수 요구사항
```bash
# Node.js 버전: 18 이상
# npm 버전: 9 이상
# 데이터베이스: SQLite (개발용), PostgreSQL (프로덕션)
```

### 환경 변수 설정
```env
NODE_ENV=development|production
SESSION_SECRET=your-secret-key
OPENAI_API_KEY=your-openai-api-key
DATABASE_URL=your-database-url (프로덕션만)
```

### 설치 및 실행
```bash
# 의존성 설치
npm install

# 개발 서버 실행 (포트 5000)
npm run dev

# 프로덕션 빌드
npm run build

# 타입 체크
npm run check

# 데이터베이스 스키마 푸시
npm run db:push
```

## 2. 핵심 모듈별 구현 분석

### 2.1 데이터베이스 레이어 (`shared/schema.ts`)

**설계 원칙:**
- Drizzle ORM 사용으로 타입 안전성 보장
- 소프트 삭제 패턴 구현 (규제 준수)
- 관계형 데이터 구조로 데이터 무결성 확보

```typescript
// 주요 테이블 관계
users (1) ──→ (N) cases
cases (1) ──→ (N) ai_predictions  
users (1) ──→ (N) audit_logs
```

**소프트 삭제 구현:**
```typescript
// cases 테이블의 소프트 삭제 필드
isDeleted: boolean = false
deletedAt: timestamp | null
deletedBy: user_id | null  
deletionReason: string | null
```

### 2.2 API 레이어 (`server/routes.ts`)

**보안 미들웨어 체계:**
1. **requireAuth**: 인증 확인 (개발환경에서는 우회)
2. **requireRole**: 역할 기반 접근 제어
3. **auditMiddleware**: 자동 감사 로그 생성
4. **Rate Limiting**: API 호출 제한
5. **Helmet**: 보안 헤더 설정

**API 엔드포인트 구조:**
```
/api/auth       - 인증 관련
/api/users      - 사용자 관리 (ADMIN)
/api/cases      - 사례 관리 (모든 역할)
/api/predictions - AI 분석 결과 (REVIEWER+)
/api/audit-logs - 감사 로그 (ADMIN)
/api/ai-models  - AI 모델 관리 (ADMIN)
```

### 2.3 AI 서비스 (`server/ai-service.ts`)

**GPT-5 통합:**
```typescript
// 모델 설정
modelName: "gpt-5"
modelVersion: "2025-08-07"

// 분석 결과 구조
interface AIAnalysisResult {
  severity: SeverityAnalysis;
  recommendations: CaseRecommendations;
  confidence: number;
  processingTime: number;
}
```

**AI 분석 프로세스:**
1. 시스템 프롬프트 생성 (pharmacovigilance 전문)
2. 사례 데이터 구조화
3. GPT-5 API 호출 (JSON 응답 형식)
4. 결과 검증 및 신뢰도 계산
5. 데이터베이스 저장

### 2.4 데이터 액세스 레이어 (`server/storage.ts`)

**저장소 패턴:**
```typescript
interface IStorage {
  // CRUD 패턴 일관성
  // 필터링 및 검색 지원
  // 소프트 삭제 처리
  // 관계형 데이터 로딩
}
```

**주요 메서드:**
- `listCases()`: 사례 목록 조회 (필터링 지원)
- `softDeleteCase()`: 규제 준수 삭제
- `createAuditLog()`: 자동 감사 추적

## 3. 프론트엔드 아키텍처

### 3.1 React 컴포넌트 구조

```
App.tsx (라우터)
├── AppSidebar (네비게이션)
├── Dashboard (대시보드)
├── CaseManagement (사례 관리)
├── CaseDetails (사례 상세)
├── CriticalCases (긴급 사례)
├── UserManagement (사용자 관리)
├── AIModelManagement (AI 모델)
├── AuditLogs (감사 로그)
└── SystemMonitoring (시스템 모니터링)
```

### 3.2 상태 관리
- **TanStack Query**: 서버 상태 캐싱 및 동기화
- **React Hooks**: 로컬 상태 관리
- **Context API**: 테마 및 글로벌 상태

### 3.3 UI/UX 설계
- **shadcn/ui**: 일관성 있는 디자인 시스템
- **Tailwind CSS**: 유틸리티 기반 스타일링
- **Lucide Icons**: 의료 친화적 아이콘 세트
- **반응형 디자인**: 다양한 디바이스 지원

## 4. 보안 구현 세부사항

### 4.1 인증 시스템
```typescript
// 세션 기반 인증
app.use(session({
  secret: process.env.SESSION_SECRET,
  store: new PGStore({...}),
  cookie: { secure: true, httpOnly: true }
}));
```

### 4.2 역할 기반 접근 제어 (RBAC)
```typescript
const PERMISSIONS = {
  USER: ['read:own_cases', 'create:cases'],
  REVIEWER: ['read:all_cases', 'update:cases', 'read:predictions'],
  ADMIN: ['*'] // 모든 권한
};
```

### 4.3 감사 로깅
```typescript
// 모든 중요 작업 자동 로깅
const auditMiddleware = (action: string) => {
  return (req, res, next) => {
    // 사용자 정보, IP, 작업 내용 기록
    storage.createAuditLog({
      userId: req.user.id,
      action,
      ipAddress: req.ip,
      timestamp: new Date()
    });
  };
};
```

## 5. 데이터 처리 워크플로우

### 5.1 사례 등록 프로세스
```
1. 사용자 입력 → Zod 스키마 검증
2. 데이터베이스 저장 (고유 사례번호 생성)
3. AI 분석 트리거 (비동기)
4. 결과 저장 및 알림
5. 감사 로그 자동 생성
```

### 5.2 AI 분석 워크플로우
```
1. 사례 데이터 수집 및 구조화
2. 프롬프트 엔지니어링 적용
3. GPT-5 API 호출 (JSON 모드)
4. 응답 검증 및 신뢰도 계산
5. 예측 결과 저장
6. 검토자에게 알림 발송
```

### 5.3 검토 승인 프로세스
```
1. REVIEWER가 AI 분석 결과 검토
2. 승인/수정/반려 결정
3. 상태 업데이트 및 이력 관리
4. 최종 보고서 생성 준비
```

## 6. 성능 최적화 전략

### 6.1 데이터베이스 최적화
- 인덱스 최적화: 검색 필드 중심
- 커넥션 풀링: 동시 접속 관리
- 쿼리 최적화: N+1 문제 해결

### 6.2 API 성능
- 응답 캐싱: 자주 조회되는 데이터
- 페이지네이션: 대용량 데이터 처리
- 압축: gzip 응답 압축

### 6.3 프론트엔드 최적화
- 코드 스플리팅: 라우트별 청크
- 이미지 최적화: WebP 포맷 활용
- 메모이제이션: React.memo 적용

## 7. 테스트 전략

### 7.1 단위 테스트
```typescript
// AI 서비스 테스트
describe('AIAnalysisService', () => {
  test('should analyze case severity correctly', async () => {
    const result = await aiService.analyzeCase(mockCase);
    expect(result.severity.severity).toBeOneOf(['Low', 'Medium', 'High', 'Critical']);
  });
});
```

### 7.2 통합 테스트
- API 엔드포인트 테스트
- 데이터베이스 연동 테스트
- 인증/권한 테스트

### 7.3 E2E 테스트 (Playwright)
- 사용자 시나리오 기반 테스트
- 다양한 브라우저 호환성
- 모바일 반응형 테스트

## 8. 모니터링 및 로깅

### 8.1 애플리케이션 모니터링
```typescript
// 헬스 체크 엔드포인트
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    database: await checkDatabaseHealth(),
    ai_service: await checkAIServiceHealth()
  });
});
```

### 8.2 에러 추적
- 구조화된 로깅 (Winston/Pino)
- 에러 알림 시스템
- 성능 메트릭 수집

## 9. 배포 및 CI/CD

### 9.1 배포 스크립트
```bash
#!/bin/bash
# build-for-publish.sh
npm run build
npm run db:push
# 정적 파일 최적화
# 환경별 설정 적용
```

### 9.2 환경 구성
- **Development**: 인증 우회, 상세 로깅
- **Staging**: 프로덕션 유사 환경
- **Production**: 보안 강화, 성능 최적화

## 10. 확장성 고려사항

### 10.1 마이크로서비스 준비
- 도메인별 모듈 분리
- API Gateway 패턴
- 이벤트 기반 아키텍처

### 10.2 대용량 데이터 처리
- 샤딩 전략 수립
- 읽기 전용 복제본 활용
- 배치 처리 시스템 도입

### 10.3 AI 서비스 확장
- 다중 AI 모델 지원
- A/B 테스트 프레임워크
- 모델 버전 관리 시스템

## 결론

이 약물감시 시스템은 현대적인 웹 개발 베스트 프랙티스를 따르며, 의료 도메인의 특수한 요구사항을 충족하도록 설계되었습니다. 타입 안전성, 보안, 성능, 확장성을 모두 고려한 견고한 아키텍처를 제공합니다.

향후 ICSR 국제 표준 완전 준수와 대규모 데이터 처리 최적화를 통해 글로벌 약물감시 플랫폼으로 발전시킬 수 있는 기반이 마련되어 있습니다.